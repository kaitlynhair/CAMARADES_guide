# Automation

## Background

## Automating searches

For SOLES projects or "living" searches for systematic reviews, you may want to programmatically search for relevant citations. From our experience, if the project will contain >50,000 citations, the initial *big* search should be performed manuall due to API usage limits.

In this chapter, you will find example code to obtain citation data automatically for different databases. 

### Load R packages
Install / load these packages which are required for multiple functions described below
```{r}
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
  
library(dplyr)
library(markdown)
library(kableExtra)
library(plyr)
```

### Web of Science Search

1. Install the rwos package from GitHub
Note that you may also need to install the `devtools` package if not yet installed

```{r}
library(devtools)
install_github("kaitlynhair/rwos")
library("rwos")
```

2. Write a query 
Write a query the same way as you would do on the web page but with additional single quotation marks ' around it. Make this query an object. 
```{r}
wos_query <- 'TS=(coronavirus OR "corona virus" OR coronavirinae OR coronaviridae OR betacoronavirus OR covid OR covid19 OR "covid 19" OR nCoV OR "CoV 2" OR CoV2 OR sarscov2 OR 2019nCoV OR "novel CoV" OR "wuhan virus") OR TS=((wuhan OR hubei OR huanan) AND ("severe acute respiratory" OR pneumonia) AND (outbreak)) OR TI=(coronavirus OR "corona virus" OR coronavirinae OR coronaviridae OR betacoronavirus OR covid OR covid19 OR "covid 19" OR nCoV OR "CoV 2" OR CoV2 OR sarscov2 OR 2019nCoV OR "novel CoV" OR "wuhan virus") OR TI=((wuhan OR hubei OR huanan) AND ("severe acute respiratory" OR pneumonia) AND (outbreak))'
```

3. Search
If you have institituional access to the WoS Lite API, you can use this function to import citations programmatically. We recommend connecting to your institutional VPN and trying the code below - if it works, you have access. 

The **search_wos()** function allows you to unput a search query and timespan. Input the timespan you are interested in retrieving new records from e.g. "2week", "1year", "5month". A key limitation is that this function cannot currently pull in abstract information.

```{r}
wos_results <- search_wos(wos_query, timespan = "1day")
```

4. See your results
Take a quick look at the resulting dataframe
```{r}
wos_results %>%
  glimpse()
```

### Scopus Search

1. Install the ScopusAPI package from GitHub
Note that you may also need to install the `devtools` package if not yet installed

```{r}
library(devtools)
install_github("kaitlynhair/scopusAPI")
library(scopusAPI)
```
 
2. Write a query
```{r}
scopus_query <- "(coronavir*  OR  corona+virus* OR  betacoronavir*  OR  covid19  OR  covid+19  OR  ncov  OR  cov  2  OR  cov2  OR  sarscov2  OR  2019ncov  OR  2019+novel+coronavirus*  OR  2019+novel+CoV  OR  wuhan+virus* )  OR  ((wuhan  OR  hubei  OR  huanan)  AND  (severe+acute+respiratory  OR  pneumonia* )  AND  outbreak*)"
```

3. Search the database
The **search_scopus()** function allows you to unput a search query, API key, and a maximal number of records to retrieve. At present, there is no method of limiting a scopus search by date. Instead, we recommend working out how many new records are published (on average) between one search and another search. The retirved search is **ordered by date** and the **retMax** parameter in the function allows you to set the number of records you would like to retrieve. If you set it at 100, you will therefore retrieve the latest 100 records. 

```{r}
scopus_results <- search_scopus(string = scopus_query, api_key=Sys.getenv("SCOPUS_API_TOKEN"), retMax=10)
```

4. Check your results!
```{r}
scopus_results %>%
   glimpse()
```

### PubMed Search
1. Load package
```{r}
install.packages("RISmed")
library(RISmed)
```

2. Write a query
```{r}
query <- "\"Alzheimer Disease\" [All Fields] OR \"alzheimers disease\"[All Fields] OR alzheimer*[All Fields]"
```

3. Run search
```{r}
pubmed_search <- EUtilsSummary(query, retmax=50, mindate = "2022/05/03", maxdate="2022/05/03",  type="esearch", db="pubmed")

summary(pubmed_search)
```

4. 
```{r}
records<- EUtilsGet(pubmed_search)
```

5. Format authors
```{r}
authors<-vector()
author1<-vector()
for(n in 1:length(records@Author)){
  tmp<-paste0(records@Author[[n]]$LastName,", ",records@Author[[n]]$Initials)
  tmp2<-paste(tmp, collapse="; ")
  authors<-append(authors,tmp2)
  author1<-append(author1,records@Author[[n]]$LastName[1])
}
```

6. Format dataframe
```{r}
pubmed_results <- data.frame('authors'=authors, 'title'=ArticleTitle(records),                          'abstract'=AbstractText(records),'journal'=MedlineTA(records), 
                          'pages'=MedlinePgn(records),
                          'volume'=Volume(records),'issue'=Issue(records),
                          'year'=YearPubmed(records),
                          'pmid'=PMID(records), 'doi'=ELocationID(records), 
                          'url'=paste0("https://www.ncbi.nlm.nih.gov/pubmed/",
                                        PMID(records)), 'author1'=author1) 

```

7. See your data
```{r}
pubmed_results %>% 
  glimpse()
```

### Combining searches
```{r}
combined_search <- rbind.fill(wos_results, scopus_results, pubmed_results)
```


## Automating deduplication
## Automating screening
## Automating data extraction
## SOLES projects


